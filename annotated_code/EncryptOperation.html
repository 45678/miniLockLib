<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>miniLockLib/EncryptOperation.coffee</title>
  <link rel="stylesheet" href="../stylesheet.css">
  <script src="../annotated_code.js"></script>
</head>
<body class="avenir calibri consolas annotated_code">

<header>
  <h1>
    <a href="../"><svg viewBox="0 0 525 702" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <g fill-rule="evenodd">
        <rect fill="#FFFFFF" x="60" y="320" width="420" height="320"></rect>
        <path fill="#000000" d="M347.8125,478.934579 C369.558712,478.934579 387.1875,461.310499 387.1875,439.570093 C387.1875,417.829688 369.558712,400.205607 347.8125,400.205607 C326.066288,400.205607 308.4375,417.829688 308.4375,439.570093 C308.4375,461.310499 326.066288,478.934579 347.8125,478.934579 Z M177.1875,478.934579 C198.933712,478.934579 216.5625,461.310499 216.5625,439.570093 C216.5625,417.829688 198.933712,400.205607 177.1875,400.205607 C155.441288,400.205607 137.8125,417.829688 137.8125,439.570093 C137.8125,461.310499 155.441288,478.934579 177.1875,478.934579 Z M177.1875,255.869159 L177.1875,223.065421 L177.228748,223.065421 C177.201304,221.975295 177.1875,220.881783 177.1875,219.785047 C177.1875,149.12873 234.481061,91.8504673 305.15625,91.8504673 C375.831439,91.8504673 433.125,149.12873 433.125,219.785047 C433.125,220.881783 433.111196,221.975295 433.083752,223.065421 L433.125,223.065421 L433.125,255.869159 L523.525694,255.869159 L525,255.869159 L525,219.785047 C525,98.4011172 426.5726,0 305.15625,0 C183.7399,0 85.3125,98.4011172 85.3125,219.785047 L85.3125,255.869159 L86.7868059,255.869159 L177.1875,255.869159 L177.1875,255.869159 Z M131.25,616.71028 C105.879419,616.71028 85.3125,596.148853 85.3125,570.785047 L85.3125,347.719626 L439.6875,347.719626 L439.6875,570.785047 C439.6875,596.148853 419.120581,616.71028 393.75,616.71028 L131.25,616.71028 L131.25,616.71028 Z M131.25,702 C58.7626266,702 0,643.253064 0,570.785047 L0,255.869159 L525,255.869159 L525,570.785047 C525,643.253064 466.237373,702 393.75,702 L131.25,702 L131.25,702 Z"></path>
      </g>
    </svg><b>mini</b><b>Lock</b><b>Lib</b></a>/<b>EncryptOperation<span class="ext">.coffee</span></b>
  </h1>
</header>



<section id="section-1">
  <div class="annotation"></div>
  <div class="code"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EncryptOperation</span></span>
  NaCl = <span class="hljs-built_in">require</span> <span class="hljs-string">"tweetnacl"</span>
  NaCl.stream = <span class="hljs-built_in">require</span>(<span class="hljs-string">"nacl-stream"</span>).stream
  BLAKE2s = <span class="hljs-built_in">require</span> <span class="hljs-string">"./BLAKE2s"</span>
  ID = <span class="hljs-built_in">require</span> <span class="hljs-string">"./ID"</span>
  {numberToByteArray} = <span class="hljs-built_in">require</span> <span class="hljs-string">"./util"</span>
  Blob = <span class="hljs-built_in">window</span>?.Blob <span class="hljs-keyword">or</span> <span class="hljs-built_in">require</span> <span class="hljs-string">"./Blob"</span>

  chunkSize: <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>
  readSliceOfData: <span class="hljs-built_in">require</span> <span class="hljs-string">"./readSliceOfData"</span>

  constructor: <span class="hljs-function"><span class="hljs-params">(params={})</span>-&gt;</span>
    {@data, @keys, @name, @type, @time, @miniLockIDs, @version, @callback} = params
    @version = <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> @version <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
    @ephemeral = NaCl.box.keyPair()
    @fileKey = NaCl.randomBytes(<span class="hljs-number">32</span>)
    @fileNonce = NaCl.randomBytes(<span class="hljs-number">24</span>).subarray(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>)
    @hash = <span class="hljs-keyword">new</span> BLAKE2s(length: <span class="hljs-number">32</span>)
    @ciphertextBytes = []
    @start() <span class="hljs-keyword">if</span> params.start?

  start: <span class="hljs-function"><span class="hljs-params">(callback)</span> =&gt;</span>
    @callback = callback <span class="hljs-keyword">if</span> callback?
    <span class="hljs-keyword">if</span> @callback?.constructor <span class="hljs-keyword">isnt</span> Function
      <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can’t start encrypt operation without callback function."</span>
    <span class="hljs-keyword">switch</span>
      <span class="hljs-keyword">when</span> (@data <span class="hljs-keyword">instanceof</span> Blob) <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span>
        @callback <span class="hljs-string">"Can’t encrypt without a Blob of data."</span>
      <span class="hljs-keyword">when</span> (@keys?.publicKey <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">or</span> (@keys?.secretKey <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>)
        @callback <span class="hljs-string">"Can’t encrypt without a set of keys."</span>
      <span class="hljs-keyword">when</span> (@miniLockIDs <span class="hljs-keyword">instanceof</span> Array) <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span>
        @callback <span class="hljs-string">"Can’t encrypt without an Array of miniLock IDs."</span>
      <span class="hljs-keyword">when</span> @name <span class="hljs-keyword">and</span> @name.length &gt; <span class="hljs-number">256</span>
        @callback <span class="hljs-string">"Can’t encrypt because file name is too long. 256-characters max please."</span>
      <span class="hljs-keyword">when</span> @type <span class="hljs-keyword">and</span> @type.length &gt; <span class="hljs-number">128</span>
        @callback <span class="hljs-string">"Can’t encrypt because media type is too long. 128-characters max please."</span>
      <span class="hljs-keyword">when</span> (@version <span class="hljs-keyword">in</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]) <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span>
        @callback <span class="hljs-string">"Can’t encrypt because version <span class="hljs-subst">#{@version}</span> is not supported. Version 1 or 2 please."</span>
      <span class="hljs-keyword">else</span>
        @startedAt = Date.now()
        @time = @startedAt <span class="hljs-keyword">if</span> @time <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
        @run()
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>

  run: <span class="hljs-function">-&gt;</span>
    @encryptAttributes(@version)
    @encryptData <span class="hljs-number">0</span>, <span class="hljs-function"><span class="hljs-params">(error, dataWasEncrypted)</span> =&gt;</span>
      <span class="hljs-keyword">if</span> dataWasEncrypted?
        @constructHeader()
        fileFormat = [
          <span class="hljs-string">"miniLock"</span>
          @sizeOfHeaderIn4Bytes
          @headerJSONBytes
          @ciphertextBytes...
        ]
        @end(error, <span class="hljs-keyword">new</span> Blob fileFormat, type: <span class="hljs-string">"application/minilock"</span>)
      <span class="hljs-keyword">else</span>
        @end(error)

  end: <span class="hljs-function"><span class="hljs-params">(error, blob)</span> =&gt;</span>
    @streamEncryptor.clean() <span class="hljs-keyword">if</span> @streamEncryptor?
    @endedAt = Date.now()
    @duration = @endedAt - @startedAt
    <span class="hljs-keyword">if</span> error
      @onerror(error)
    <span class="hljs-keyword">else</span>
      @oncomplete(blob)

  oncomplete: <span class="hljs-function"><span class="hljs-params">(blob)</span> -&gt;</span>
    @callback(<span class="hljs-literal">undefined</span>, {
      data: blob
      name: @name + <span class="hljs-string">".minilock"</span>
      type: @type
      time: @time
      senderID: ID.encode(@keys.publicKey)
      duration: @duration
      startedAt: @startedAt
      endedAt: @endedAt
    })

  onerror: <span class="hljs-function"><span class="hljs-params">(error)</span> -&gt;</span>
    @callback(error)

  encryptAttributes: <span class="hljs-function"><span class="hljs-params">(version)</span> -&gt;</span>
    @constructStreamEncryptor()
    bytes = <span class="hljs-keyword">switch</span> version
      <span class="hljs-keyword">when</span> <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">new</span> Uint8Array <span class="hljs-number">256</span>
      <span class="hljs-keyword">when</span> <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">new</span> Uint8Array <span class="hljs-number">256</span>+<span class="hljs-number">128</span>+<span class="hljs-number">24</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-string">"EncryptOperation does not support version <span class="hljs-subst">#{version}</span>. Version 1 or 2 please."</span>
    bytes.set @fixedSizeDecodedName(), <span class="hljs-number">0</span>
    bytes.set @fixedSizeDecodedType(), <span class="hljs-number">256</span> <span class="hljs-keyword">if</span> version <span class="hljs-keyword">is</span> <span class="hljs-number">2</span>
    bytes.set @fixedSizeDecodedTime(), <span class="hljs-number">256</span>+<span class="hljs-number">128</span> <span class="hljs-keyword">if</span> version <span class="hljs-keyword">is</span> <span class="hljs-number">2</span>
    <span class="hljs-keyword">if</span> encryptedBytes = @streamEncryptor.encryptChunk(bytes, <span class="hljs-literal">no</span>)
      @hash.update(encryptedBytes)
      @ciphertextBytes.push(encryptedBytes)
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-string">"EncryptOperation failed to record file attributes."</span>

  encryptData: <span class="hljs-function"><span class="hljs-params">(position, callback)</span> -&gt;</span>
    @constructStreamEncryptor()
    @readSliceOfData position, position+@chunkSize, <span class="hljs-function"><span class="hljs-params">(error, sliceOfBytes)</span> =&gt;</span>
      <span class="hljs-keyword">if</span> error <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> callback(error)
      isLastSlice = position+sliceOfBytes.length <span class="hljs-keyword">is</span> @data.size
      <span class="hljs-keyword">if</span> encryptedBytes = @streamEncryptor.encryptChunk(sliceOfBytes, isLastSlice)
        @hash.update(encryptedBytes)
        @ciphertextBytes.push(encryptedBytes)
        <span class="hljs-keyword">if</span> isLastSlice
          @hash.digest()
          callback(<span class="hljs-literal">undefined</span>, @hash.isFinished)
        <span class="hljs-keyword">else</span>
          @encryptData(position+@chunkSize, callback)
      <span class="hljs-keyword">else</span>
        callback <span class="hljs-string">"Failed to encrypt slice of data at [<span class="hljs-subst">#{position}</span>..<span class="hljs-subst">#{position+@chunkSize}</span>]"</span>

  constructHeader: <span class="hljs-function">-&gt;</span>
    @header =
      version: @version
      ephemeral: NaCl.util.encodeBase64(@ephemeral.publicKey)
      decryptInfo: @encodedEncryptedPermits()
    headerJSON = JSON.stringify(@header)
    @sizeOfHeaderIn4Bytes = numberToByteArray(headerJSON.length)
    @headerJSONBytes = NaCl.util.decodeUTF8(headerJSON)
    <span class="hljs-keyword">return</span> @header

  constructStreamEncryptor: <span class="hljs-function">-&gt;</span>
    @streamEncryptor ?= NaCl.stream.createEncryptor(@fileKey, @fileNonce, @chunkSize)

  fixedSizeDecodedName: <span class="hljs-function">-&gt;</span>
    fixedSize = <span class="hljs-keyword">new</span> Uint8Array(<span class="hljs-number">256</span>)
    <span class="hljs-keyword">if</span> @name
      decodedName = NaCl.util.decodeUTF8(@name)
      <span class="hljs-keyword">if</span> decodedName.length &gt; fixedSize.length
        <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can’t set fixed size decoded name because input is too long."</span>
      fixedSize.set(decodedName)
    <span class="hljs-keyword">return</span> fixedSize

  fixedSizeDecodedType: <span class="hljs-function">-&gt;</span>
    fixedSize = <span class="hljs-keyword">new</span> Uint8Array(<span class="hljs-number">128</span>)
    <span class="hljs-keyword">if</span> @type
      decodedType = NaCl.util.decodeUTF8(@type)
      <span class="hljs-keyword">if</span> decodedType.length &gt; fixedSize.length
        <span class="hljs-keyword">throw</span> <span class="hljs-string">"Can’t set fixed size decoded type because input is too long."</span>
      fixedSize.set(decodedType)
    <span class="hljs-keyword">return</span> fixedSize

  fixedSizeDecodedTime: <span class="hljs-function">-&gt;</span>
    fixedSize = <span class="hljs-keyword">new</span> Uint8Array(<span class="hljs-number">24</span>)
    <span class="hljs-keyword">if</span> @time
      timestamp = (<span class="hljs-keyword">new</span> Date(@time)).toJSON()
      fixedSize.set(NaCl.util.decodeUTF8(timestamp))
    <span class="hljs-keyword">return</span> fixedSize

  encodedEncryptedPermits: <span class="hljs-function">-&gt;</span>
    permits = {}
    <span class="hljs-keyword">for</span> miniLockID <span class="hljs-keyword">in</span> @miniLockIDs
      [uniqueNonce, encryptedPermit] = @encryptedPermit(miniLockID)
      encodedUniqueNonce = NaCl.util.encodeBase64(uniqueNonce)
      encodedEncryptedPermit = NaCl.util.encodeBase64(encryptedPermit)
      permits[encodedUniqueNonce] = encodedEncryptedPermit
    <span class="hljs-keyword">return</span> permits

  encryptedPermit: <span class="hljs-function"><span class="hljs-params">(miniLockID)</span> -&gt;</span>
    [uniqueNonce, permit] = @permit(miniLockID)
    decodedPermitJSON = NaCl.util.decodeUTF8(JSON.stringify(permit))
    recipientPublicKey = ID.decode(miniLockID)
    encryptedPermit = NaCl.box(decodedPermitJSON, uniqueNonce, recipientPublicKey, @ephemeral.secretKey)
    [uniqueNonce, encryptedPermit]

  permit: <span class="hljs-function"><span class="hljs-params">(miniLockID)</span> -&gt;</span>
    uniqueNonce = NaCl.randomBytes(<span class="hljs-number">24</span>)
    [uniqueNonce, {
      senderID: ID.encode(@keys.publicKey)
      recipientID: miniLockID
      fileInfo: NaCl.util.encodeBase64(@encryptedFileInfo(miniLockID, uniqueNonce))
    }]

  encryptedFileInfo: <span class="hljs-function"><span class="hljs-params">(miniLockID, uniqueNonce)</span> -&gt;</span>
    decodedFileInfoJSON = NaCl.util.decodeUTF8(JSON.stringify(@permitFileInfo()))
    recipientPublicKey = ID.decode(miniLockID)
    NaCl.box(decodedFileInfoJSON, uniqueNonce, recipientPublicKey, @keys.secretKey)

  permitFileInfo: <span class="hljs-function">-&gt;</span>
    fileKey:   NaCl.util.encodeBase64(@fileKey)
    fileNonce: NaCl.util.encodeBase64(@fileNonce)
    fileHash:  NaCl.util.encodeBase64(@hash.digest())</pre></div></div>
</section>


<nav class="files">
  <a  href="index.html"  >library/index<span class="ext">.coffee</span></a>
  
  
  
  <br>
  <a href="BLAKE2s.html">library/BLAKE2s<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Blob.html">library/Blob<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="DecryptOperation.html">library/DecryptOperation<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="EmailAddress.html">library/EmailAddress<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a >library/EncryptOperation<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="ID.html">library/ID<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="KeyPairOperation.html">library/KeyPairOperation<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="SecretPhrase.html">library/SecretPhrase<span class="ext">.coffee</span></a>
  
  
  
  
  
  
  
  <br>
  <a href="readSliceOfData.html">library/readSliceOfData<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="util.html">library/util<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="A Few Demo Tests.html">tests/A Few Demo Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Acceptability Tests.html">tests/Acceptability Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Decrypt Operation Tests.html">tests/Decrypt Operation Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Encrypt Operation Tests.html">tests/Encrypt Operation Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Identification Tests.html">tests/Identification Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Make Key Pair Tests.html">tests/Make Key Pair Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Slow Operation Tests.html">tests/Slow Operation Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="fixtures.html">tests/fixtures<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="test_setup.html">tests/test_setup<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="window_test_harness.html">tests/window_test_harness<span class="ext">.coffee</span></a>
  
  
</nav>

</body>
</html>
