<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>miniLockLib/KeyPairOperation.coffee</title>
  <link rel="stylesheet" href="../stylesheet.css">
  <script src="../annotated_code.js"></script>
</head>
<body class="avenir calibri consolas annotated_code">

<header>
  <h1>
    <a href="../"><svg viewBox="0 0 525 702" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <g fill-rule="evenodd">
        <rect fill="#FFFFFF" x="60" y="320" width="420" height="320"></rect>
        <path fill="#000000" d="M347.8125,478.934579 C369.558712,478.934579 387.1875,461.310499 387.1875,439.570093 C387.1875,417.829688 369.558712,400.205607 347.8125,400.205607 C326.066288,400.205607 308.4375,417.829688 308.4375,439.570093 C308.4375,461.310499 326.066288,478.934579 347.8125,478.934579 Z M177.1875,478.934579 C198.933712,478.934579 216.5625,461.310499 216.5625,439.570093 C216.5625,417.829688 198.933712,400.205607 177.1875,400.205607 C155.441288,400.205607 137.8125,417.829688 137.8125,439.570093 C137.8125,461.310499 155.441288,478.934579 177.1875,478.934579 Z M177.1875,255.869159 L177.1875,223.065421 L177.228748,223.065421 C177.201304,221.975295 177.1875,220.881783 177.1875,219.785047 C177.1875,149.12873 234.481061,91.8504673 305.15625,91.8504673 C375.831439,91.8504673 433.125,149.12873 433.125,219.785047 C433.125,220.881783 433.111196,221.975295 433.083752,223.065421 L433.125,223.065421 L433.125,255.869159 L523.525694,255.869159 L525,255.869159 L525,219.785047 C525,98.4011172 426.5726,0 305.15625,0 C183.7399,0 85.3125,98.4011172 85.3125,219.785047 L85.3125,255.869159 L86.7868059,255.869159 L177.1875,255.869159 L177.1875,255.869159 Z M131.25,616.71028 C105.879419,616.71028 85.3125,596.148853 85.3125,570.785047 L85.3125,347.719626 L439.6875,347.719626 L439.6875,570.785047 C439.6875,596.148853 419.120581,616.71028 393.75,616.71028 L131.25,616.71028 L131.25,616.71028 Z M131.25,702 C58.7626266,702 0,643.253064 0,570.785047 L0,255.869159 L525,255.869159 L525,570.785047 C525,643.253064 466.237373,702 393.75,702 L131.25,702 L131.25,702 Z"></path>
      </g>
    </svg><b>mini</b><b>Lock</b><b>Lib</b></a>/<b>KeyPairOperation<span class="ext">.coffee</span></b>
  </h1>
</header>



<section id="section-1">
  <div class="annotation"></div>
  <div class="code"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KeyPairOperation</span></span>
  <span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">this</span>

  BLAKE2s = <span class="hljs-built_in">require</span> <span class="hljs-string">"./BLAKE2s"</span>
  EmailAddress = <span class="hljs-built_in">require</span> <span class="hljs-string">"./EmailAddress"</span>
  NaCl = <span class="hljs-built_in">require</span> <span class="hljs-string">"./NaCl"</span>
  scrypt = <span class="hljs-built_in">require</span> <span class="hljs-string">"./scrypt-async"</span>
  SecretPhrase = <span class="hljs-built_in">require</span> <span class="hljs-string">"./SecretPhrase"</span>

  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(params)</span> -&gt;</span>
    {<span class="hljs-property">@secretPhrase</span>, <span class="hljs-property">@emailAddress</span>} = params</pre></div></div>
</section>


<section id="section-2">
  <div class="annotation"><p>Decode secret phrase input string into a <code>Uint8Array</code> of bytes.</p>
</div>
  <div class="code"><div class='highlight'><pre>  <span class="hljs-attribute">secret</span>:<span class="hljs-function"> -&gt;</span>
    NaCl.util.decodeUTF8(<span class="hljs-property">@secretPhrase</span>)</pre></div></div>
</section>


<section id="section-3">
  <div class="annotation"><p>Decode email address input string into a <code>Uint8Array</code> of bytes.</p>
</div>
  <div class="code"><div class='highlight'><pre>  <span class="hljs-attribute">salt</span>:<span class="hljs-function"> -&gt;</span>
    NaCl.util.decodeUTF8(<span class="hljs-property">@emailAddress</span>)</pre></div></div>
</section>


<section id="section-4">
  <div class="annotation"><p>Hash digest of the <code>secret()</code> to increase its potential complexity (hand wave?).</p>
</div>
  <div class="code"><div class='highlight'><pre>  <span class="hljs-attribute">hashDigestOfSecret</span>:<span class="hljs-function"> -&gt;</span>
    (<span class="hljs-keyword">new</span> BLAKE2s <span class="hljs-attribute">length</span>: <span class="hljs-number">32</span>).update(<span class="hljs-property">@secret</span>()).digest()</pre></div></div>
</section>


<section id="section-5">
  <div class="annotation"><p>Start the operation.
<code>callback</code> receives <code>error</code> or <code>keys</code> when the operation is complete.</p>
</div>
  <div class="code"><div class='highlight'><pre>  <span class="hljs-attribute">start</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
    <span class="hljs-keyword">switch</span>
      <span class="hljs-keyword">when</span> callback?.constructor <span class="hljs-keyword">isnt</span> Function
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Can’t make keys without a callback function."</span>
      <span class="hljs-keyword">when</span> <span class="hljs-property">@secretPhrase</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
        callback <span class="hljs-string">"Can’t make keys without a secret phrase."</span>
      <span class="hljs-keyword">when</span> SecretPhrase.isAcceptable(<span class="hljs-property">@secretPhrase</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span>
        callback <span class="hljs-string">"Can’t make keys because '<span class="hljs-subst">#{<span class="hljs-property">@secretPhrase</span>}</span>' is not an acceptable secret phrase."</span>
      <span class="hljs-keyword">when</span> <span class="hljs-property">@emailAddress</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
        callback <span class="hljs-string">"Can’t make keys without an email address."</span>
      <span class="hljs-keyword">when</span> EmailAddress.isAcceptable(<span class="hljs-property">@emailAddress</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span>
        callback <span class="hljs-string">"Can’t make keys because '<span class="hljs-subst">#{<span class="hljs-property">@emailAddress</span>}</span>' is not an acceptable email address."</span>
      <span class="hljs-keyword">when</span> <span class="hljs-property">@secretPhrase</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@emailAddress</span> <span class="hljs-keyword">and</span> callback
        calculateCurve25519KeyPair <span class="hljs-property">@hashDigestOfSecret</span>(), <span class="hljs-property">@salt</span>(), <span class="hljs-function"><span class="hljs-params">(keys)</span> -&gt;</span>
          callback(<span class="hljs-literal">undefined</span>, keys)</pre></div></div>
</section>


<section id="section-6">
  <div class="annotation"><p>Calculate a curve25519 key pair for the given <code>secret</code> and <code>salt</code>.</p>
</div>
  <div class="code"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">calculateCurve25519KeyPair</span> = <span class="hljs-params">(secret, salt, callback)</span> -&gt;</span>
<span class="hljs-function">    <span class="hljs-title">whenKeysAreReady</span> = <span class="hljs-params">(encodedBytes)</span> -&gt;</span>
      decodedBytes = NaCl.util.decodeBase64(encodedBytes)
      keys = NaCl.box.keyPair.fromSecretKey(decodedBytes)
      callback(keys)
    logN          = <span class="hljs-number">17</span>       <span class="hljs-comment"># CPU/memory cost parameter (1 to 31).</span>
    r             = <span class="hljs-number">8</span>        <span class="hljs-comment"># Block size parameter. (I don’t know about this).</span>
    dkLen         = <span class="hljs-number">32</span>       <span class="hljs-comment"># Length of derived keys. (A miniLock key is 32 numbers).</span>
    interruptStep = <span class="hljs-number">1000</span>     <span class="hljs-comment"># Steps to split calculation with timeouts (default 1000).</span>
    encoding      = <span class="hljs-string">"base64"</span> <span class="hljs-comment"># Output encoding ("base64", "hex", or null).</span>
    scrypt(secret, salt, logN, r, dkLen, interruptStep, whenKeysAreReady, encoding)</pre></div></div>
</section>


<nav class="files">
  <a  href="index.html"  >library/index<span class="ext">.coffee</span></a>
  
  
  
  <br>
  <a href="BLAKE2s.html">library/BLAKE2s<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Base58.html">library/Base58<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="DecryptOperation.html">library/DecryptOperation<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="EmailAddress.html">library/EmailAddress<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="EncryptOperation.html">library/EncryptOperation<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="ID.html">library/ID<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a >library/KeyPairOperation<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="NaCl.html">library/NaCl<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="SecretPhrase.html">library/SecretPhrase<span class="ext">.coffee</span></a>
  
  
  
  
  
  
  
  <br>
  <a href="readSliceOfData.html">library/readSliceOfData<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="util.html">library/util<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="A Few Demo Tests.html">tests/A Few Demo Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Acceptability Tests.html">tests/Acceptability Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Decrypt Operation Tests.html">tests/Decrypt Operation Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Encrypt Operation Tests.html">tests/Encrypt Operation Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Identification Tests.html">tests/Identification Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Make Key Pair Tests.html">tests/Make Key Pair Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Slow Operation Tests.html">tests/Slow Operation Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="fixtures.html">tests/fixtures<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="tape_test_harness.html">tests/tape_test_harness<span class="ext">.coffee</span></a>
  
  
</nav>
</body>
</html>
