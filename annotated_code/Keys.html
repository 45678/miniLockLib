<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>miniLockLib/Keys.coffee</title>
  <link rel="stylesheet" href="../stylesheet.css">
  <script src="../annotated_code.js"></script>
</head>
<body class="avenir calibri consolas annotated_code">

<header>
  <h1>
    <a href="../"><svg viewBox="0 0 525 702" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <g fill-rule="evenodd">
        <rect fill="#FFFFFF" x="60" y="320" width="420" height="320"></rect>
        <path fill="#000000" d="M347.8125,478.934579 C369.558712,478.934579 387.1875,461.310499 387.1875,439.570093 C387.1875,417.829688 369.558712,400.205607 347.8125,400.205607 C326.066288,400.205607 308.4375,417.829688 308.4375,439.570093 C308.4375,461.310499 326.066288,478.934579 347.8125,478.934579 Z M177.1875,478.934579 C198.933712,478.934579 216.5625,461.310499 216.5625,439.570093 C216.5625,417.829688 198.933712,400.205607 177.1875,400.205607 C155.441288,400.205607 137.8125,417.829688 137.8125,439.570093 C137.8125,461.310499 155.441288,478.934579 177.1875,478.934579 Z M177.1875,255.869159 L177.1875,223.065421 L177.228748,223.065421 C177.201304,221.975295 177.1875,220.881783 177.1875,219.785047 C177.1875,149.12873 234.481061,91.8504673 305.15625,91.8504673 C375.831439,91.8504673 433.125,149.12873 433.125,219.785047 C433.125,220.881783 433.111196,221.975295 433.083752,223.065421 L433.125,223.065421 L433.125,255.869159 L523.525694,255.869159 L525,255.869159 L525,219.785047 C525,98.4011172 426.5726,0 305.15625,0 C183.7399,0 85.3125,98.4011172 85.3125,219.785047 L85.3125,255.869159 L86.7868059,255.869159 L177.1875,255.869159 L177.1875,255.869159 Z M131.25,616.71028 C105.879419,616.71028 85.3125,596.148853 85.3125,570.785047 L85.3125,347.719626 L439.6875,347.719626 L439.6875,570.785047 C439.6875,596.148853 419.120581,616.71028 393.75,616.71028 L131.25,616.71028 L131.25,616.71028 Z M131.25,702 C58.7626266,702 0,643.253064 0,570.785047 L0,255.869159 L525,255.869159 L525,570.785047 C525,643.253064 466.237373,702 393.75,702 L131.25,702 L131.25,702 Z"></path>
      </g>
    </svg><b>mini</b><b>Lock</b><b>Lib</b></a>/<b>Keys<span class="ext">.coffee</span></b>
  </h1>
</header>



<section id="section-1">
  <div class="annotation"></div>
  <div class="code"><div class='highlight'><pre>BLAKE2s = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./BLAKE2s"</span>)
NaCl    = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./NaCl"</span>)
scrypt  = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./scrypt-async"</span>)
zxcvbn  = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./zxcvbn"</span>)</pre></div></div>
</section>


<section id="section-2">
  <div class="annotation"><p>Make a set of keys for a secret phrase and email address. Your <code>callback</code>
receives a pair of <code>keys</code>, or an <code>error</code>, like this:</p>
<pre><code>miniLockLib.makeKeyPair secretPhrase, emailAddress, <span class="hljs-function"><span class="hljs-params">(error, keys)</span> -&gt;</span>
   <span class="hljs-keyword">if</span> keys?
     keys.publicKey <span class="hljs-keyword">is</span> a Uint8Array
     keys.secretKey <span class="hljs-keyword">is</span> a Uint8Array
     error <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
   <span class="hljs-keyword">else</span>
     error <span class="hljs-keyword">is</span> a String explaining the failure
     keys <span class="hljs-keyword">in</span> <span class="hljs-literal">undefined</span>
</code></pre><p>The secret phrase and email address are both tested to make sure they meet
miniLock’s standards. The phrase must be at least 32 characters long and it
must contain at least 100 bits of entropy. The address musn’t be invalid. If
either input is unacceptable your <code>callback</code> will receive an explanation of
the failure as its <code>error</code> argument.</p>
<p>Making a pair of keys will take a few seconds — please be patient.</p>
</div>
  <div class="code"><div class='highlight'><pre>
exports.m<span class="hljs-function"><span class="hljs-title">akeKeyPair</span> = <span class="hljs-params">(secretPhrase, emailAddress, callback)</span> -&gt;</span>
  <span class="hljs-keyword">switch</span>
    <span class="hljs-keyword">when</span> callback?.constructor <span class="hljs-keyword">isnt</span> Function
      <span class="hljs-keyword">return</span> <span class="hljs-string">"Can’t make a pair of keys without a callback function."</span>
    <span class="hljs-keyword">when</span> secretPhrase <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
      callback <span class="hljs-string">"Can’t make a pair of keys without a secret phrase."</span>
    <span class="hljs-keyword">when</span> exports.secretPhraseIsAcceptable(secretPhrase) <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span>
      callback <span class="hljs-string">"Can’t make a pair of keys because the secret phrase is unacceptable."</span>
    <span class="hljs-keyword">when</span> emailAddress <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
      callback <span class="hljs-string">"Can’t make a pair of keys without an email address."</span>
    <span class="hljs-keyword">when</span> exports.emailAddressIsAcceptable(emailAddress) <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span>
      callback <span class="hljs-string">"Can’t make a pair of keys because the email address is unacceptable."</span>
    <span class="hljs-keyword">when</span> secretPhrase <span class="hljs-keyword">and</span> emailAddress <span class="hljs-keyword">and</span> callback</pre></div></div>
</section>


<section id="section-3">
  <div class="annotation"><p>Decode each input into a Uint8Array of bytes.</p>
</div>
  <div class="code"><div class='highlight'><pre>      decodedSecretPhrase = NaCl.util.decodeUTF8(secretPhrase)
      decodedEmailAddress = NaCl.util.decodeUTF8(emailAddress)</pre></div></div>
</section>


<section id="section-4">
  <div class="annotation"><p>Create a hash digest of the decoded secret phrase to increase its complexity.</p>
</div>
  <div class="code"><div class='highlight'><pre>      hashDigestOfDecodedSecretPhrase = (<span class="hljs-keyword">new</span> BLAKE2s <span class="hljs-attribute">length</span>: <span class="hljs-number">32</span>).update(decodedSecretPhrase).digest()</pre></div></div>
</section>


<section id="section-5">
  <div class="annotation"><p>Calculate keys for the hash of the secret phrase with email address as salt.</p>
</div>
  <div class="code"><div class='highlight'><pre>      calculateCurve25519KeyPair hashDigestOfDecodedSecretPhrase, decodedEmailAddress, <span class="hljs-function"><span class="hljs-params">(keys)</span> -&gt;</span>
        callback(<span class="hljs-literal">undefined</span>, keys)</pre></div></div>
</section>


<section id="section-6">
  <div class="annotation"><p>Calculate a curve25519 key pair for the given <code>secret</code> and <code>salt</code>.</p>
</div>
  <div class="code"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">calculateCurve25519KeyPair</span> = <span class="hljs-params">(secret, salt, callback)</span> -&gt;</span></pre></div></div>
</section>


<section id="section-7">
  <div class="annotation"><p>Decode and unpack the keys when the task is complete.</p>
</div>
  <div class="code"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">whenKeysAreReady</span> = <span class="hljs-params">(encodedBytes)</span> -&gt;</span>
    decodedBytes = NaCl.util.decodeBase64(encodedBytes)
    keys = NaCl.box.keyPair.fromSecretKey(decodedBytes)
    callback(keys)</pre></div></div>
</section>


<section id="section-8">
  <div class="annotation"><p>Define miniLock <code>scrypt</code> parameters for the calculation task:</p>
</div>
  <div class="code"><div class='highlight'><pre>  logN          = <span class="hljs-number">17</span>       <span class="hljs-comment"># CPU/memory cost parameter (1 to 31).</span>
  r             = <span class="hljs-number">8</span>        <span class="hljs-comment"># Block size parameter. (I don’t know about this).</span>
  dkLen         = <span class="hljs-number">32</span>       <span class="hljs-comment"># Length of derived keys. (A miniLock key is 32 numbers).</span>
  interruptStep = <span class="hljs-number">1000</span>     <span class="hljs-comment"># Steps to split calculation with timeouts (default 1000).</span>
  encoding      = <span class="hljs-string">"base64"</span> <span class="hljs-comment"># Output encoding ("base64", "hex", or null).</span></pre></div></div>
</section>


<section id="section-9">
  <div class="annotation"><p>Send the task to <code>scrypt</code> for processing…</p>
</div>
  <div class="code"><div class='highlight'><pre>  scrypt(secret, salt, logN, r, dkLen, interruptStep, whenKeysAreReady, encoding)</pre></div></div>
</section>


<section id="section-10">
  <div class="annotation"><p>An acceptable secret phrases is at least 32 characters long and
has at least 100 bits of entropy.</p>
</div>
  <div class="code"><div class='highlight'><pre>exports.s<span class="hljs-function"><span class="hljs-title">ecretPhraseIsAcceptable</span> = <span class="hljs-params">(secretPhrase)</span> -&gt;</span>
  secretPhrase?.length &gt;= <span class="hljs-number">32</span> <span class="hljs-keyword">and</span> zxcvbn(secretPhrase).entropy &gt;= <span class="hljs-number">100</span></pre></div></div>
</section>


<section id="section-11">
  <div class="annotation"><p>miniLock only accepts relatively standards compliant email addresses.</p>
</div>
  <div class="code"><div class='highlight'><pre>exports.e<span class="hljs-function"><span class="hljs-title">mailAddressIsAcceptable</span> = <span class="hljs-params">(emailAddress)</span> -&gt;</span>
  EmailAddressPattern.test(emailAddress)

EmailAddressPattern = <span class="hljs-regexp">/[-0-9A-Z.+_]+@[-0-9A-Z.+_]+\.[A-Z]{2,20}/i</span></pre></div></div>
</section>


<nav class="files">
  <a  >library/index<span class="ext">.coffee</span></a>
  
  
  
  <br>
  <a href="AbstractOperation.html">library/AbstractOperation<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="BLAKE2s.html">library/BLAKE2s<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Base58.html">library/Base58<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="DecryptOperation.html">library/DecryptOperation<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="EncryptOperation.html">library/EncryptOperation<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="ID.html">library/ID<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a >library/Keys<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="NaCl.html">library/NaCl<span class="ext">.coffee</span></a>
  
  
  
  
  
  
  
  <br>
  <a href="util.html">library/util<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="A Few Demo Tests.html">tests/A Few Demo Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Acceptability Tests.html">tests/Acceptability Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Decrypt Operation Tests.html">tests/Decrypt Operation Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Encrypt Operation Tests.html">tests/Encrypt Operation Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Identification Tests.html">tests/Identification Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Key Pair Tests.html">tests/Key Pair Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Slow Operation Tests.html">tests/Slow Operation Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="fixtures.html">tests/fixtures<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="tape_test_harness.html">tests/tape_test_harness<span class="ext">.coffee</span></a>
  
  
</nav>
</body>
</html>
