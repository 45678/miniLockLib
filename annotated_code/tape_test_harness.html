<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>miniLockLib/tape_test_harness.coffee</title>
  <link rel="stylesheet" href="../stylesheet.css">
  <script src="../annotated_code.js"></script>
</head>
<body class="avenir calibri consolas annotated_code">

<header>
  <h1>
    <a href="../"><svg viewBox="0 0 525 702" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <g fill-rule="evenodd">
        <rect fill="#FFFFFF" x="60" y="320" width="420" height="320"></rect>
        <path fill="#000000" d="M347.8125,478.934579 C369.558712,478.934579 387.1875,461.310499 387.1875,439.570093 C387.1875,417.829688 369.558712,400.205607 347.8125,400.205607 C326.066288,400.205607 308.4375,417.829688 308.4375,439.570093 C308.4375,461.310499 326.066288,478.934579 347.8125,478.934579 Z M177.1875,478.934579 C198.933712,478.934579 216.5625,461.310499 216.5625,439.570093 C216.5625,417.829688 198.933712,400.205607 177.1875,400.205607 C155.441288,400.205607 137.8125,417.829688 137.8125,439.570093 C137.8125,461.310499 155.441288,478.934579 177.1875,478.934579 Z M177.1875,255.869159 L177.1875,223.065421 L177.228748,223.065421 C177.201304,221.975295 177.1875,220.881783 177.1875,219.785047 C177.1875,149.12873 234.481061,91.8504673 305.15625,91.8504673 C375.831439,91.8504673 433.125,149.12873 433.125,219.785047 C433.125,220.881783 433.111196,221.975295 433.083752,223.065421 L433.125,223.065421 L433.125,255.869159 L523.525694,255.869159 L525,255.869159 L525,219.785047 C525,98.4011172 426.5726,0 305.15625,0 C183.7399,0 85.3125,98.4011172 85.3125,219.785047 L85.3125,255.869159 L86.7868059,255.869159 L177.1875,255.869159 L177.1875,255.869159 Z M131.25,616.71028 C105.879419,616.71028 85.3125,596.148853 85.3125,570.785047 L85.3125,347.719626 L439.6875,347.719626 L439.6875,570.785047 C439.6875,596.148853 419.120581,616.71028 393.75,616.71028 L131.25,616.71028 L131.25,616.71028 Z M131.25,702 C58.7626266,702 0,643.253064 0,570.785047 L0,255.869159 L525,255.869159 L525,570.785047 C525,643.253064 466.237373,702 393.75,702 L131.25,702 L131.25,702 Z"></path>
      </g>
    </svg><b>mini</b><b>Lock</b><b>Lib</b></a>/<b>tape_test_harness<span class="ext">.coffee</span></b>
  </h1>
</header>



<section id="section-1">
  <div class="annotation"></div>
  <div class="code"><div class='highlight'><pre><span class="hljs-keyword">if</span> location.hostname <span class="hljs-keyword">is</span> <span class="hljs-string">"45678.github.io"</span> <span class="hljs-keyword">and</span> location.protocol <span class="hljs-keyword">isnt</span> <span class="hljs-string">"https:"</span>
  <span class="hljs-built_in">window</span>.location = location.toString().replace(<span class="hljs-string">"http:"</span>, <span class="hljs-string">"https:"</span>)

tape = <span class="hljs-built_in">require</span>(<span class="hljs-string">"tape"</span>)
<span class="hljs-built_in">module</span>.exports = tape.createHarness()

testTemplate = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"test_template"</span>)
failureTemplate = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"failure_template"</span>)
assertionTemplate = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"assertion_template"</span>)
numberOfTests = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"number_of_tests"</span>)
numberOfFailedTests = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"number_of_failed_tests"</span>)
body = <span class="hljs-built_in">document</span>.body
idOfCurrentlyRunningTest = <span class="hljs-literal">undefined</span>
untouched = <span class="hljs-literal">true</span>
failedTests = []

<span class="hljs-built_in">window</span>.o<span class="hljs-function"><span class="hljs-title">nmousewheel</span> = -&gt;</span>
  <span class="hljs-built_in">window</span>.onmousewheel = <span class="hljs-literal">undefined</span>
  untouched = <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">delay</span> = <span class="hljs-params">(amount, callback)</span> -&gt;</span> setTimeout(callback, amount)

<span class="hljs-built_in">module</span>.exports.createStream(<span class="hljs-attribute">objectMode</span>:<span class="hljs-literal">yes</span>).<span class="hljs-literal">on</span> <span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
  <span class="hljs-keyword">switch</span>
    <span class="hljs-keyword">when</span> data.type <span class="hljs-keyword">is</span> <span class="hljs-string">"test"</span>
      idOfCurrentlyRunningTest = data.id
      insertTestElement(data)
      renderBodyElement(data)
    <span class="hljs-keyword">when</span> data.operator?
      fixBrokenThrowsOperatorData(data)
      <span class="hljs-keyword">if</span> data.ok <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span>
        failedTests.push(idOfCurrentlyRunningTest) <span class="hljs-keyword">unless</span> idOfCurrentlyRunningTest <span class="hljs-keyword">in</span> failedTests
      element = findElementForTest(idOfCurrentlyRunningTest)
      renderTestElementUpdate(element, data)
      insertTestAssertion(element, data)
      insertFailure(element, data) <span class="hljs-keyword">unless</span> data.ok
    <span class="hljs-keyword">when</span> data.type <span class="hljs-keyword">is</span> <span class="hljs-string">"end"</span>
      idOfCurrentlyRunningTest = <span class="hljs-literal">undefined</span>
      renderTestElementEnded(findElementForTest(data.test), data)
      numberOfFailedTests.innerText = failedTests.length <span class="hljs-keyword">if</span> failedTests.length <span class="hljs-keyword">isnt</span> <span class="hljs-number">0</span>
      numberOfTests.innerText = data.test
      renderBodyElement(data)
    <span class="hljs-keyword">else</span>
      <span class="hljs-built_in">console</span>.info(<span class="hljs-string">"Unhandled"</span>, data)
<span class="hljs-function">
<span class="hljs-title">renderBodyElement</span> = <span class="hljs-params">(data)</span> -&gt;</span>
  body.className = body.className.replace(<span class="hljs-string">"undefined"</span>, <span class="hljs-string">""</span>)
  body.className = <span class="hljs-keyword">switch</span>
    <span class="hljs-keyword">when</span> data.type <span class="hljs-keyword">is</span> <span class="hljs-string">"test"</span>
      body.className.replace(<span class="hljs-string">"stopped"</span>, <span class="hljs-string">"running"</span>)
    <span class="hljs-keyword">when</span> data.type <span class="hljs-keyword">is</span> <span class="hljs-string">"end"</span>
      body.className.replace(<span class="hljs-string">"running"</span>, <span class="hljs-string">"stopped"</span>)
    <span class="hljs-keyword">else</span>
      body.className
  <span class="hljs-keyword">if</span> failedTests.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> body.className.indexOf(<span class="hljs-string">"fail"</span>) <span class="hljs-keyword">is</span> -<span class="hljs-number">1</span>
    body.className += <span class="hljs-string">" failures"</span>
<span class="hljs-function">
<span class="hljs-title">insertTestElement</span> = <span class="hljs-params">(data)</span> -&gt;</span>
  element = testTemplate.cloneNode(<span class="hljs-literal">true</span>)
  element.id = <span class="hljs-string">"test_<span class="hljs-subst">#{data.id}</span>"</span>
  element.querySelector(<span class="hljs-string">".name"</span>).innerText = data.name
  element.className += <span class="hljs-string">" started"</span>
  element.startedAt = Date.now()
  element.querySelector(<span class="hljs-string">"div.id"</span>).innerText = (data.id / <span class="hljs-number">1000</span>).toFixed(<span class="hljs-number">3</span>).replace(<span class="hljs-string">"0."</span>, <span class="hljs-string">"#"</span>)
  container = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'tests'</span>)
  container.appendChild(element)
  containerHeight = parseInt getComputedStyle(container)[<span class="hljs-string">'height'</span>]
  bodyHeight = parseInt getComputedStyle(<span class="hljs-built_in">document</span>.body)[<span class="hljs-string">'height'</span>]
  <span class="hljs-keyword">if</span> (containerHeight &gt; bodyHeight)
    <span class="hljs-built_in">document</span>.body.style.height = <span class="hljs-string">"<span class="hljs-subst">#{containerHeight}</span>px"</span>
  element.scrollIntoView() <span class="hljs-keyword">if</span> untouched
<span class="hljs-function">
<span class="hljs-title">renderTestElementUpdate</span> = <span class="hljs-params">(element, data)</span> -&gt;</span>
  className = <span class="hljs-keyword">if</span> data.ok <span class="hljs-keyword">then</span> <span class="hljs-string">"ok"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"failed"</span>
  element.className = element.className.replace(className,<span class="hljs-string">""</span>).trim() + <span class="hljs-string">" "</span> + className
<span class="hljs-function">
<span class="hljs-title">renderTestElementEnded</span> = <span class="hljs-params">(element, data)</span> -&gt;</span>
  element.className = element.className.replace(<span class="hljs-string">"started"</span>, <span class="hljs-string">"ended"</span>)
  element.querySelector(<span class="hljs-string">"div.duration"</span>).innerText = <span class="hljs-string">"<span class="hljs-subst">#{((Date.now() - element.startedAt) / <span class="hljs-number">1000</span>).toFixed(<span class="hljs-number">2</span>)}</span>s"</span>
<span class="hljs-function">
<span class="hljs-title">insertTestAssertion</span> = <span class="hljs-params">(element, data)</span> -&gt;</span>
  assertionEl = assertionTemplate.cloneNode(<span class="hljs-literal">true</span>)
  assertionEl.id = <span class="hljs-string">"test_<span class="hljs-subst">#{idOfCurrentlyRunningTest}</span>_assertion_<span class="hljs-subst">#{data.id}</span>"</span>
  element.className = element.className.replace(<span class="hljs-string">'empty'</span>, <span class="hljs-string">''</span>).trim()
  element.querySelector(<span class="hljs-string">'.assertions'</span>).appendChild(assertionEl)
<span class="hljs-function">
<span class="hljs-title">insertFailure</span> = <span class="hljs-params">(element, data)</span> -&gt;</span>
  failureEl = failureTemplate.cloneNode(<span class="hljs-string">"true"</span>)
  failureEl.id = <span class="hljs-string">""</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> data.expected <span class="hljs-keyword">is</span> <span class="hljs-string">"function"</span>
    failureEl.querySelector(<span class="hljs-string">"pre.expected"</span>).innerHTML += data.expected
  <span class="hljs-keyword">else</span>
    failureEl.querySelector(<span class="hljs-string">"pre.expected"</span>).innerHTML += JSON.stringify(data.expected, <span class="hljs-literal">undefined</span>, <span class="hljs-string">"  "</span>)
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> data.actual <span class="hljs-keyword">is</span> <span class="hljs-string">"function"</span>
    failureEl.querySelector(<span class="hljs-string">"pre.received"</span>).innerHTML += data.actual
  <span class="hljs-keyword">else</span>
    failureEl.querySelector(<span class="hljs-string">"pre.received"</span>).innerHTML += JSON.stringify(data.actual, <span class="hljs-literal">undefined</span>, <span class="hljs-string">"  "</span>)
  <span class="hljs-keyword">if</span> data.error?
    failureEl.querySelector(<span class="hljs-string">"pre.error_stack"</span>).innerText = data.error.stack
  element.appendChild(failureEl)
  <span class="hljs-keyword">if</span> failedTests.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> untouched <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span>
      delay <span class="hljs-number">1</span>,<span class="hljs-function"> -&gt;</span>
        untouched = <span class="hljs-literal">false</span>
        element.scrollIntoView(<span class="hljs-literal">true</span>)
<span class="hljs-function">
<span class="hljs-title">fixBrokenThrowsOperatorData</span> = <span class="hljs-params">(data)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> (data.operator <span class="hljs-keyword">is</span> <span class="hljs-string">"throws"</span>) <span class="hljs-keyword">and</span> (data.name <span class="hljs-keyword">isnt</span> data.actual)
    data.ok = <span class="hljs-literal">no</span>
    data.expected = data.name
    data.name = <span class="hljs-literal">undefined</span>
    data.fixedForThrowsOperator = <span class="hljs-literal">yes</span>
<span class="hljs-function">
<span class="hljs-title">findElementForTest</span> = <span class="hljs-params">(id)</span> -&gt;</span>
  <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"test_<span class="hljs-subst">#{id}</span>"</span>)</pre></div></div>
</section>


<nav class="files">
  <a  href="index.html"  >library/index<span class="ext">.coffee</span></a>
  
  
  
  <br>
  <a href="BLAKE2s.html">library/BLAKE2s<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="DecryptOperation.html">library/DecryptOperation<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="EmailAddress.html">library/EmailAddress<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="EncryptOperation.html">library/EncryptOperation<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="ID.html">library/ID<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="KeyPairOperation.html">library/KeyPairOperation<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="NaCl.html">library/NaCl<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="SecretPhrase.html">library/SecretPhrase<span class="ext">.coffee</span></a>
  
  
  
  
  
  
  
  <br>
  <a href="readSliceOfData.html">library/readSliceOfData<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="util.html">library/util<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="A Few Demo Tests.html">tests/A Few Demo Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Acceptability Tests.html">tests/Acceptability Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Decrypt Operation Tests.html">tests/Decrypt Operation Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Encrypt Operation Tests.html">tests/Encrypt Operation Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Identification Tests.html">tests/Identification Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Make Key Pair Tests.html">tests/Make Key Pair Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="Slow Operation Tests.html">tests/Slow Operation Tests<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a href="fixtures.html">tests/fixtures<span class="ext">.coffee</span></a>
  
  
  
  
  <br>
  <a >tests/tape_test_harness<span class="ext">.coffee</span></a>
  
  
</nav>
</body>
</html>
